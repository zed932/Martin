<div class="test-management">
  <div class="management-header">
    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏</h3>
    <button
      class="btn-primary"
      (click)="!isEditing ? showAddTestForm = !showAddTestForm : cancelEdit()">
      {{ isEditing ? '‚úï –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : (showAddTestForm ? '‚úï –û—Ç–º–µ–Ω–∞' : '+ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç') }}
    </button>
  </div>

  @if (showAddTestForm) {
    <div class="add-test-form">
      <h4>{{ isEditing ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞' : '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞' }}</h4>

      @if (errorMessage) {
        <div class="alert alert-danger">{{ errorMessage }}</div>
      }

      <form [formGroup]="testForm" (ngSubmit)="createOrUpdateTest()">
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ *</label>
          <input
            type="text"
            formControlName="title"
            class="form-control"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞"
            [class.is-invalid]="title?.invalid && title?.touched">
          @if (title?.invalid && title?.touched) {
            <div class="invalid-feedback">
              –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
            </div>
          }
        </div>

        <div class="form-group">
          <label>–¢–µ–º–∞ *</label>
          <select
            formControlName="topic"
            class="form-control"
            [class.is-invalid]="topic?.invalid && topic?.touched">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</option>
            @for (topicItem of topics; track topicItem.value) {
              <option [value]="topicItem.value">{{ topicItem.label }}</option>
            }
          </select>
          @if (topic?.invalid && topic?.touched) {
            <div class="invalid-feedback">
              –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É —Ç–µ—Å—Ç–∞
            </div>
          }
        </div>

        <div class="form-group">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ *</label>
          <textarea
            formControlName="description"
            class="form-control"
            rows="3"
            placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞"
            [class.is-invalid]="description?.invalid && description?.touched"></textarea>
          @if (description?.invalid && description?.touched) {
            <div class="invalid-feedback">
              –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
            </div>
          }
        </div>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
            <select formControlName="difficulty" class="form-control">
              @for (level of difficultyLevels; track level.value) {
                <option [value]="level.value">{{ level.label }}</option>
              }
            </select>
          </div>

          <div class="form-group col-md-6">
            <label>–í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–º–∏–Ω—É—Ç) *</label>
            <input
              type="number"
              formControlName="timeLimit"
              class="form-control"
              min="5"
              max="180"
              [class.is-invalid]="timeLimit?.invalid && timeLimit?.touched">
            @if (timeLimit?.invalid && timeLimit?.touched) {
              <div class="invalid-feedback">
                –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 5 –¥–æ 180 –º–∏–Ω—É—Ç
              </div>
            }
          </div>
        </div>

        <div class="form-group">
          <label>–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª (%)</label>
          <input
            type="number"
            formControlName="passingScore"
            class="form-control"
            min="0"
            max="100"
            [class.is-invalid]="passingScore?.invalid && passingScore?.touched">
          @if (passingScore?.invalid && passingScore?.touched) {
            <div class="invalid-feedback">
              –ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 100
            </div>
          }
        </div>

        <!-- –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ -->
        <app-test-questions
          [questionsFormArray]="questionsFormArray"
          (questionsChange)="onQuestionsChange($event)">
        </app-test-questions>

        <div class="form-actions">
          <button
            type="submit"
            class="btn-success"
            [disabled]="testForm.invalid || questionsFormArray.length === 0 || isLoading">
            @if (isLoading) {
              <span class="spinner-border spinner-border-sm me-2"></span>
            }
            {{ isEditing ? '–û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç' : '–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç' }}
          </button>
          <button
            type="button"
            class="btn-secondary"
            (click)="cancelEdit()"
            [disabled]="isLoading">
            –û—Ç–º–µ–Ω–∞
          </button>
        </div>
      </form>
    </div>
  }

  <div class="tests-list">
    <h4>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã ({{ tests.length }})</h4>

    @if (isLoading && !showAddTestForm) {
      <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
      </div>
    }

    @if (errorMessage && !showAddTestForm) {
      <div class="alert alert-danger">{{ errorMessage }}</div>
    }

    @if (tests.length === 0 && !isLoading) {
      <div class="empty-state">
        <p>–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤</p>
      </div>
    }

    @for (test of tests; track test.id) {
      <div class="test-card">
        <div class="test-info">
          <h5>{{ test.title }}</h5>
          <p>{{ test.description }}</p>
          <div class="test-meta">
            <span class="topic-badge">{{ getTopicName(test.topic) }}</span>
            <span>–í–æ–ø—Ä–æ—Å–æ–≤: {{ test.questions.length || 0 }}</span> <!-- –£–±—Ä–∞–ª–∏ ? -->
            <span>–í—Ä–µ–º—è: {{ test.timeLimit }} –º–∏–Ω</span>
            <span>–°–ª–æ–∂–Ω–æ—Å—Ç—å: {{ getDifficultyName(test.difficulty) }}</span>
            <span class="status-badge" [class.active]="test.isActive">
              {{ test.isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' }}
            </span>
          </div>
        </div>
        <div class="test-actions">
          <button class="btn-edit" (click)="editTest(test)">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn-delete" (click)="deleteTest(test.id)">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    }
  </div>
</div>
